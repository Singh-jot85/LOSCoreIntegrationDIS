from los.configurations.models import Configuration, OrganizationConfiguration

interfaces = {
    "ci-tenant-map": {
        "lrtcapital": {
            "module": "core_integration.fiserv.fiserv_adapter",
            "adapter": "FiservAdapter",
            "corebanking_name": "fiserv",
        },
    },
    "ci-fiserv-common": {
        "validation_spec": "{}",
        "request_body_spec": "{}",
        "response_body_spec": {
            "errors": {"errorMsg": "", "errorNum": ""},
            "responses": "",
            "apiSuccess": True,
        },
    },
    "ci-fiserv-entity-mapping": {
        "method_config": [],
        "relation_types": [
            "borrower",
            "co_borrower",
            "owner",
            "guarantor"
        ],
        "search_accounts": {},
        "search_customers": {
            "method_name": {
                "entity": "execute_search_company_request",
                "individual": "execute_search_contact_request"
            },
            "get_tranformed_config": {
                "entity": "search_company",
                "individual": "search_contact"
            }
        },
        "default_document_type": ""
    },
    "ci-fiserv-direct_sign_on": {
    "validation_spec": "{}",
    "request_body_spec": "{}",
    "response_body_spec": "{}",
    "request_body_spec_config": "{}",
    "response_body_spec_config": "{}",
    "xml_template": "<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:open=\"http://www.opensolutions.com/\"><soapenv:Header/><soapenv:Body><open:DirectSignon><open:xmlRequest><![CDATA[<DirectSSORequest MessageDateTime=\"{{current_timestamp}}-07:00\" TrackingId=\"{{TrackingId}}\"><DeviceId>{{DeviceId}}</DeviceId><UserId>{{UserId}}</UserId><Password>{{Password}}</Password><ProdEnvCd>{{ProdEnvCd}}</ProdEnvCd><ProdDefCd>{{ProdDefCd}}</ProdDefCd></DirectSSORequest> ]]></open:xmlRequest></open:DirectSignon></soapenv:Body></soapenv:Envelope>"
    },
    "ci-fiserv-who_is": {
    "validation_spec": "{}",
    "request_body_spec": "{}",
    "response_body_spec": "{}",
    "request_body_spec_config": "{}",
    "response_body_spec_config": "{}",
    "xml_template": "<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:open=\"http://www.opensolutions.com/\"><soapenv:Header /><soapenv:Body><open:WhoIs><open:xmlRequest><![CDATA[<WhoIsRequest SSOTicket=\"{{SSOTicket}}\" MessageDateTime=\"{{current_timestamp}}\" TrackingId=\"{{TrackingId}}\"><LookupSSOTicket>{{SSOTicket}}</LookupSSOTicket></WhoIsRequest>]]></open:xmlRequest></open:WhoIs></soapenv:Body></soapenv:Envelope>"
    },
    "ci-fiserv-search_company": {
        "validation_spec": "{}",
        "request_body_spec": "{ \"Input\": { \"Requests\": [ { \"__type\": \"OrganizationSearchRequest:http://www.opensolutions.com/CoreApi\", \"TaxId\": ((.loan_relations[] | .tin) // null) } ], \"UserAuthentication\": {} } }",
        "response_body_spec": "( .responses | \n { \n apiSuccess: ( if .Output.Responses[0].WasSuccessful then .Output.Responses[0].WasSuccessful else false end ),\n errors: .Output.UserAuthentication.Errors[0].ErrorMessage,\n responses: ( .Output.Responses[] | if .WasSuccessful and .Organizations then .Organizations[] | [\n { \n cif: .OrganizationNumber,\n customer_details: { \n org_name: .OrganizationName,\n tin: .OrganizationTaxIds[0].TaxId \n } \n }\n ] else null end )\n } \n)",
        "request_body_spec_config": "{}",
        "response_body_spec_config": "{}"
    },
    "ci-fiserv-search_contact": {
        "validation_spec": "{}",
        "request_body_spec": "{ \"Input\": { \"Requests\": [ { \"__type\": \"PersonSearchRequest:http://www.opensolutions.com/CoreApi\", \"TaxId\": ((.loan_relations[] | .tin) // null) } ], \"UserAuthentication\": {} } }",
        "response_body_spec": "( .responses | \n { \n apiSuccess: (if .Output.Responses[0].WasSuccessful then .Output.Responses[0].WasSuccessful else false end),\n errors: .Output.UserAuthentication.Errors[0].ErrorMessage,\n responses: ( .Output.Responses[] | ( if .WasSuccessful and .Persons then (.Persons[] | [\n { \n cif: .PersonNumber,\n customer_details: \n { \n first_name: .FirstName,\n middle_name: ( .MiddleName // \"\"),\n last_name: .LastName,\n tin: .TaxId \n } \n }\n ]) else null end ) )\n }\n)",
        "request_body_spec_config": "{}",
        "response_body_spec_config": "{}"
    },
    "ci-fiserv-account_id_gen": {
        "validation_spec": "{}",
        "request_body_spec": '{ Input: { Requests: [ { __type: "GetNewAccountNumberRequest:http://www.opensolutions.com/CoreApi", MajorAccountTypeCode: "CML", MinorAccountTypeCode: "BRLV" } ], UserAuthentication: {} } }',
        "response_body_spec": '( .responses | { apiSuccess: (if .Output.Responses[0].WasSuccessful then .Output.Responses[0].WasSuccessful else false end), errors: .Output.UserAuthentication.Errors[0].ErrorMessage, responses: ( .Output.Responses[0] | [ ( if .WasSuccessful then ({ cif: .AccountNumber}) else null end )] ) } )',
        "request_body_spec_config": "{}",
        "response_body_spec_config": "{}",
    },
    "ci-fiserv-create_loan": {
        "validation_spec": "{}",
        "request_body_spec": "(\ndef first_of_next_month_date:\n  (now | strftime(\"%Y-%m-01\") | strptime(\"%Y-%m-%d\") | mktime) \n  + (32*24*60*60)\n  | strftime(\"%Y-%m-01\")\n  | strptime(\"%Y-%m-%d\") | mktime\n  | (.*1000 | floor | tostring)\n  | \"/Date(\" + . + \")/\";\n\ndef get_NCUACategoryCode($collateral; $creTypes):\n    ({\n        \"first\": \"1TDF\",\n        \"second\": \"2TDF\"\n    }) as $positionMapping | \n    # Define SEC-producing combinations\n    ([\n        {\"category\": \"all_business_assets\", \"type\": \"all_assets\"},\n        {\"category\": \"cash_and_equivalents\", \"type\": \"deposit_account\"},\n        {\"category\": \"machinery_and_equipment\"},\n        {\"category\": \"inventory_accounts_receivable\", \"type\": \"all_accounts_receivable\"}\n    ]) as $secPairs |\n    (\n        if (INDEX($secPairs[]; \n            select(\n                .category == $collateral.category \n                and ((has(\"type\") | not) or (.type == $collateral.type))\n            ))\n        ) \n            then \"SEC\"\n        elif $collateral.category == \"residential_real_estate\" \n            then (\n                if $collateral.type == \"multi_family_dwelling\" or $collateral.type == \"1_4_family_dwelling\" \n                    then $positionMapping[$collateral.lien_position] // null\n                else null \n                end \n            )\n        elif $collateral.category == \"vehicles\" \n            then  (\n                if $collateral.type == \"motor_vehicle_new\" or $collateral.type == \"ground_transportation_new\" \n                    then \"NEWV\" \n                elif $collateral.type == \"motor_vehicle_used\" or $collateral.type == \"ground_transportation_old\" \n                    then \"USDV\" \n                else null \n                end\n            )\n        elif $collateral.category == \"land\" and $collateral.type == \"land_for_development\" \n            then $positionMapping[$collateral.lien_position] // null\n        elif $collateral.category == \"commercial_real_estate\" \n            then (\n                if ($collateral.type | IN($creTypes))\n                    then $positionMapping[$collateral.lien_position] // null\n                else null \n                end\n            )\n        else null \n        end \n    );\n{\n    Input: {\n        Requests: [\n            {\n                __type: \"AccountMaintenanceRequest:http://www.opensolutions.com/CoreApi\",\n                Accounts: [ \n                    {\n                        AccountNumber: (.loan_number // null),\n                        IsAccountMaintenance: false,\n                        MajorAccountTypeCode: \"CML\",\n                        CurrentMinorAccountTypeCode: (\n                            if .product.product_code == \"SB_LOC\" \n                                then \"BRLV\" \n                            elif .product.product_code == \"SB_TL\" \n                                then \"BTFX\" \n                            else null \n                            end\n                        ),\n                        BankOrganizationNumber: 1,\n                        PaymentAmount: (if .product.product_code == \"SB_LOC\" then null elif .product.product_code == \"SB_TL\" then ((.loan_interfaces[] | select(.interface_type == \"sherman\" and .is_latest == true) | (.details.outLOAN_BUILDER.PmtStream // .details.outEQUAL_PMT.PmtStream) | if type == \"object\" then .Pmt elif type == \"array\" then .[0].Pmt else null end) | tonumber // null) else null end),\n                        BranchOrganizationNumber: (.details.boarding_details.branch_code // 51),\n                        CalculationScheduleEffectiveDate: \"/Date(\\(now*1000 | floor))/\",\n                        OwnershipCode: (\n                            if ([.loan_relations[] | select(.relation_type == \"borrower\")] | length) == 1 \n                                then \"S\" \n                            else \"JA\" \n                            end\n                        ),\n                        NCUACategoryCode: ( \n                            [ .collaterals[] ] as $collateralList \n                            | [$collateralList[] | select(.type | IN($creTypes[])) ] as $CRECollateralList\n                            | [$collateralList[] | select(.category == \"vehicles\") ] as $AUTOCollateralList\n                            | [$collateralList[] | select(.category | IN($equipmentCategoryTypes[])) ] as $equipmentCollateralList\n                            | (\n                                if ( $collateralList | type == \"array\" and length == 0 )\n                                    then \"USEC\"\n                                elif $CRECollateralList | length > 0\n                                    then get_NCUACategoryCode($CRECollateralList[0]; $creTypes)\n                                elif $AUTOCollateralList | length > 0\n                                    then get_NCUACategoryCode($AUTOCollateralList[0]; $creTypes)\n                                elif $equipmentCollateralList | length > 0\n                                    then get_NCUACategoryCode($equipmentCollateralList[0]; $creTypes)\n                                else get_NCUACategoryCode($collateralList[0]; $creTypes)\n                                end\n                            )\n                        ),\n                        CurrentAccountStatusCode: \"ACT\",\n                        DateMaturity: (\n                            if (\n                                .product.product_code == \"SB_LOC\" \n                                or .product.product_code == \"SB_TL\"\n                            )\n                                then ( .maturity_date | \n                                    if . == null or . == \"\" \n                                        then null \n                                    else (strptime(\"%Y-%m-%d\") | mktime * 1000 | \"/Date(\\(.))/\" )\n                                    end\n                                ) \n                            else null \n                            end\n                        ), \n                        NextDueDate: (.loan_approval.approved_first_payment_date | \n                            if (. == null or . == \"\") \n                                then null \n                            else strptime(\"%Y-%m-%d\") | mktime * 1000 | \"/Date(\\(.))/\" \n                            end\n                        ),\n                        PaymentCalendarPeriodCode: \"MNTH\",\n                        OriginalBalance: (.disbursements | ( \n                            if type == \"array\" \n                                then .[0] \n                            elif type == \"object\" \n                                then . \n                            else null \n                            end ) | .disbursement_amount // null\n                        ),\n                        OriginalTerm: (.loan_approval.approved_term // null),\n                        IsShareStatement: true,\n                        IsUseProductDefaultDeliveryMethod: true,\n                        ContractDate: (.closing_date | \n                            if . == null or . == \"\" \n                                then null \n                            else strptime(\"%Y-%m-%d\") | mktime * 1000 | \"/Date(\\(.))/\" \n                            end\n                        ),\n                        InterestRate: (.loan_approval.approved_rate/100 // null),\n                        AccountRiskRating: {\n                            AccountRiskRatingEffectiveDate: (.underwriter_decision_date | \n                                if . == null or . == \"\" \n                                    then null \n                                else strptime(\"%Y-%m-%d\") | mktime * 1000 | \"/Date(\\(.))/\" \n                                end\n                            ),\n                            AccountRiskRatingCode: \"003B\"\n                        },\n                        AccountUserFields: [ {\n                            UserFieldCode: \"LCOP\",\n                            UserFieldValue: (.application_number // null)\n                        } ],\n                        AccountRoles: ( \n                            ( (\n                                if (.loan_relations[] | select(.is_primary_borrower == true) | .entity_type == \"sole_proprietor\" )\n                                    then [\n                                        {\n                                            AccountRoleCode: \"GUAR\",\n                                            AccountRoleValue: (.loan_relations[] | select(.is_primary_borrower == true) | .external_customer_id as $cif | .details.core_integration_response.customer_details[$cif].customer_details.org_cif | tostring // null),\n                                            EntityTypeCode: \"ORG\",\n                                            IsRemove: null,\n                                            LiabilityAmount: null,\n                                            LiabilityPercent: null\n                                        },\n                                        {\n                                            AccountRoleCode: \"SIGN\",\n                                            AccountRoleValue: (.loan_relations[] | select(.is_primary_borrower == true) | .external_customer_id // null),\n                                            EntityTypeCode: \"PERS\",\n                                            IsRemove: null,\n                                            LiabilityAmount: null,\n                                            LiabilityPercent: null\n                                        } \n                                    ] \n                                else [ .flat_relations[] \n                                    | select(\n                                        .external_customer_id != null\n                                        and .is_collateral_related == false\n                                    ) ]\n                                    | map(\n                                        {\n                                            AccountRoleCode: ( \n                                                if .relation_type == \"borrower\" \n                                                    then \"GUAR\" \n                                                elif .relation_type == \"guarantor\"\n                                                    then \"GUAR\" \n                                                elif .relation_type == \"owner\" \n                                                    then \"SIGN\" \n                                                else null \n                                                end\n                                            ),\n                                            AccountRoleValue: (.external_customer_id // null),\n                                            EntityTypeCode: (\n                                                if .party_type == \"individual\" \n                                                    then \"PERS\" \n                                                else \"ORG\" \n                                                end\n                                            ),\n                                            IsRemove: null,\n                                            LiabilityAmount: null,\n                                            LiabilityPercent: null\n                                        }\n                                    )\n                                end ) \n                            ) + \n                            ( \n                                .details.boarding_details | to_entries\n                                | map(\n                                    select(\n                                        ( .key | IN(\"acto\",\"loff\",\"oemp\") )\n                                        and .value != null \n                                        and .value != \"\" \n                                    )\n                                )\n                                | map(\n                                    {\n                                        AccountRoleCode: (.key | ascii_upcase),\n                                        AccountRoleValue: (\n                                            if .value \n                                                then (.value | tonumber)\n                                            else null\n                                            end\n                                        ),\n                                        EntityTypeCode: \"PERS\",\n                                        IsRemove: null,\n                                        LiabilityAmount: null,\n                                        LiabilityPercent: null\n                                    }\n                                )\n                            ) \n                        ),\n                        Organizations: [{\n                            IsTaxReportedForOwner: true,\n                            IsTaxReportedForSigner: true,\n                            OrganizationNumber: ((.loan_relations[] | select(.is_primary_borrower == true) | .external_customer_id) // null),\n                            AccountRoles: [{\n                                AccountRoleCode: \"GUAR\"\n                            }],\n                            CreditScores: {\n                                CreditScore: (.loan_interfaces[] | select(.interface_type == \"lumos\") | .details.lumos_response.results.lumosPrediction.lumos.score // null),\n                                ScoreDate: (((.loan_interfaces[] | select(.interface_type == \"lumos\") | .details.lumos_response.metadata.applicationRunDate // null) | if . == null or . == \"\" then null else split(\"T\")[0] | strptime(\"%Y-%m-%d\") | mktime * 1000 | \"/Date(\\(.))/\" end) // null)\n                            }\n                        }],\n                        AccountLoanDetail: {                            \n                            AccountLoanInformation: {\n                                LoanSourceCode: \"LCOP\",\n                                IsLoanLimit: (if .product.product_code == \"SB_LOC\" then true elif .product.product_code == \"SB_TL\" then false else null end),\n                                CRACategoryCode: (.cra_loan_type // null), \n                                CreditReportTypeCode: \"EXCL\",\n                                CreditScore: (.fico_score | tostring // null),\n                                Date1stPmtDue: (.loan_approval.approved_first_payment_date | if . == null or . == \"\" then null else strptime(\"%Y-%m-%d\") | mktime * 1000 | \"/Date(\\(.))/\" end), \n                                EstMaturityDate: (if .product.product_code == \"SB_TL\" then null elif .product.product_code == \"SB_LOC\" then (.maturity_date | if . == null or . == \"\" then null else strptime(\"%Y-%m-%d\") | mktime * 1000 | \"/Date(\\(.))/\" end) else null end),\n                                LineOfCreditCloseDate: null,\n                                GraceDays: \"10\",\n                                IsBalloonLoan: false,\n                                IsBillingLeadDaysOverrideNull: false,\n                                IsDemandLoan: false,\n                                IsLateFeeCalculationVariablesToAccountLevel: true,\n                                IsNonRESPA: null,\n                                IsNotRealEstate: false,\n                                IsPrinSurplusProc: false,\n                                IsRateChangeReCalulatedPayment: (if .product.product_code == \"SB_LOC\" then true elif .product.product_code == \"SB_TL\" then false else null end),\n                                IsRepricingPlanAllowed: false,\n                                IsRestructured: null,\n                                IsRevolveLoan: (if .product.product_code == \"SB_LOC\" then true elif .product.product_code == \"SB_TL\" then false else null end),\n                                LoanLossCategoryCode: \"COMM\",\n                                LoanQualityCode: null,\n                                MultiDueDates: null,\n                                NextPaymentChangeDate: null,\n                                OTSLoanCategoryCode: null,\n                                OddDaysInterestDue: null,\n                                OrignalLTVRatio: (if .approved_amount then .approved_amount / .total_collateral_value_v2 else null end),\n                                PaymentDueDayNumber: \"1\",\n                                PaymentMethodCode: \"BILL\",\n                                PmtChangeLeadDays: null,\n                                PurposeCode: (\n                                    if $purposeCode[.loan_purpose] \n                                        then $purposeCode[.loan_purpose] \n                                    else \"OTHR\" \n                                    end\n                                ),\n                                RateChangeLeadDays: null,\n                                RefinancedPriorAccountNumber: null,\n                                RiskRatingCode: \"003B\",\n                                UpdateWhenNull: null\n                            },\n                            AccountLoanLimitHistory: {\n                                CreditLimitAmount: (\n                                    if .product.product_code == \"SB_LOC\" \n                                        then (.loan_approval.approved_amount // null) \n                                    else null end\n                                ),\n                                EffectiveDate: \"/Date(\\(now*1000 | floor))/\",\n                                InactiveDate: (if .product.product_code == \"SB_LOC\" then (.maturity_date | if . == null or . == \"\" then null else strptime(\"%Y-%m-%d\") | mktime * 1000 | \"/Date(\\(.))/\" end) else null end)\n                            },\n                            AccountHolds: (if any(.loan_relations[]?.collaterals[]?; \n                                .category == \"cash_and_equivalents\" and .type == \"deposit_account\") \n                                then \n                                .loan_relations[] \n                                | .collaterals[] \n                                | select(.category == \"cash_and_equivalents\" and .type == \"deposit_account\") \n                                else \n                                null \n                                end) | {\n                                AccountHoldCode: (if . == null then null else \"COLH\" end), \n                                DepositAccountNumber: (if . == null then null else .details.account_number end), \n                                HoldAmount: (if . == null then null else .details.pledged_amount end), \n                                },\n                            AccountReviewHistory: {\n                                ReviewDate: (if .product.product_code == \"SB_TL\" then \"/Date(\\((now + 31536000)*1000 | floor))/\" else null end)\n                            },\n                            AccountInterestHistoryInformations: [\n                                {\n                                    AmortizationTerm: (.loan_approval.approved_term * 30.4375 // null) | round,\n                                    BalanceCategoryCode: \"NOTE\",\n                                    CalculationScheduleNumber: (if .product.product_code == \"SB_LOC\" then 3 elif .product.product_code == \"SB_TL\" then 4 else null end),\n                                    DaysMethodCode: \"ACT\",\n                                    EffectiveDate: \"/Date(\\(now*1000 | floor))/\",\n                                    InterestBase: \"360\",\n                                    InterestMethodCode: \"SMP\",\n                                    IsCapitalizeInterest: false,\n                                    IsNegativeAmortizationAllowed: false,\n                                    MarginFixed: (if .differential_rate then (.differential_rate/100 | tostring) else null end),\n                                    MaximumInterestRate: (.max_rate/100 // null),\n                                    MinimumInterestRate: ( .loan_approval.approved_rate/100 // null ),\n                                    NextRateChangeDate: (\n                                        if .product.product_code == \"SB_LOC\" \n                                            then first_of_next_month_date\n                                        else null \n                                        end\n                                    ),\n                                    PaymentChangeCalenderPeriodCode: (if .product.product_code == \"SB_LOC\" then \"MNTH\" else null end), \n                                    RateChangeCalendarPeriodCode: (if .product.product_code == \"SB_LOC\" then \"MNTH\" else null end), \n                                    RateChangeMethodCode: (if .product.product_code == \"SB_LOC\" then \"CALP\" else null end),\n                                    RateTypeCode: (if .product.product_code == \"SB_LOC\" then \"VAR\" elif .product.product_code == \"SB_TL\" then \"FIX\" else null end)\n                                }\n                            ],\n                            AccountPaymentHistoryInformation: {\n                                IsMajorMinorOverride: false,\n                                PaymentBalanceCategoryCode: \"NOTE\",\n                                PaymentBalanceTypeCode: (if .product.product_code == \"SB_LOC\" then \"INT\" elif .product.product_code == \"SB_TL\" then \"DUE\" else null end),\n                                PaymentCalendarPeriodCode: \"MNTH\",\n                                PaymentDueDayNumber: \"1\",\n                                PaymentTypeCode: (if .product.product_code == \"SB_LOC\" then \"VINT\" elif .product.product_code == \"SB_TL\" then \"FDUE\" else null end)\n                            }\n                        }\n                    }\n                ]\n            } \n        ],\n        UserAuthentication: {}\n    }\n}\n)",
        "response_body_spec": "( .responses | { apiSuccess: (if .Output.Responses[0].WasSuccessful then .Output.Responses[0].WasSuccessful else false end), errors: {errorMsg: .Output.Responses[0].Errors[0].ErrorMessage, errorNum: .Output.Responses[0].Errors[0].ErrorNumber}, responses: ( .Output.Responses[0] | ( if .WasSuccessful then ({ id: .ResponseAccounts[0].AccountNumber, AccountNumber: .ResponseAccounts[0].AccountNumber}) else null end )) } )",
        "request_body_spec_config": "{\n    \"purposeCode\": {\n        \"Working Capital\": \"WKCP\",\n        \"Leasehold Improvement\": \"LSIM\",\n        \"Purchase Equipment\": \"PUEQ\",\n        \"Purchase Transport Equip\": \"PUTE\",\n        \"Purchase Other Capital Assets\": \"PUCA\",\n        \"Purchase Com'l RE\": \"PUCR\",\n        \"Other\": \"OTHR\",\n        \"Debt Consolidation\": \"DEBT\",\n        \"Debt Refinance\": \"DEBT\"\n    },\n    \"creTypes\": [\n        \"other_cre\",\n        \"office_flex\",\n        \"commercial_condominium\",\n        \"church\",\n        \"warehouse\",\n        \"healthcare\",\n        \"industrial\",\n        \"shopping_center\",\n        \"restaurant\",\n        \"office\",\n        \"retail\"\n    ],\n    \"equipmentCategoryTypes\": [\n        \"machinery_and_equipment\",\n        \"cash_and_equivalents\"\n    ]\n}",
        "response_body_spec_config": "{}"
    },
    "ci-fiserv-create_payments_account": {
        "validation_spec": "{}",
        "request_body_spec": "{\n    Input: {\n        Requests: [\n            {\n                __type: \"RepetitiveTransferMaintenanceRequest:http://www.opensolutions.com/CoreApi\",\n                RequestNumber: \"1\",\n                AllotmentRequests: [\n                    {\n                        ACHReceivingAccountTypeCode: \"LN\",\n                        ACHReceivingTypeCode: \"ORG\",\n                        BalanceCategoryCode: \"NOTE\",\n                        BalanceTypeCode: \"BAL\",\n                        RtxnTypeCode: \"XWTH\",\n                        AllotmentTypeCode: (\n                            if (.product.product_code == \"SB_LOC\")\n                                then \"LPMT\"\n                            elif (.product.product_code == \"SB_TL\")\n                                then \"SCHD\"\n                            else null end \n                        // null),\n                        CalenderPeriodCode: \"MNTH\",\n                        FundTypeCode: \"EL\",\n                        DueDayNumber: null, #01\n                        EffectiveDate: \"/Date(\\($currentDateTime))/\",\n                        InitialDueDate: (\n                            if (.loan_approval.approved_first_payment_date)\n                                then (.loan_approval.approved_first_payment_date \n                                    | (.+ \"T00:00:00Z\" | fromdateiso8601 * 1000) \n                                    | \"/Date(\\(.))/\"\n                                )\n                            else null\n                            end\n                        ),\n                        NextDisbursementDate: (\n                            if (.loan_approval.approved_first_payment_date)\n                                then (.loan_approval.approved_first_payment_date \n                                    | (.+ \"T00:00:00Z\" | fromdateiso8601 * 1000) \n                                    | \"/Date(\\(.))/\"\n                                )\n                            else null\n                            end\n                        ),\n                        FixedAmount: (\n                            if (.product.product_type.product_type_code == \"LOC\")\n                                then null\n                            elif (.product.product_code == \"SB_TL\")\n                                then( .loan_interfaces[] | select(.interface_type==\"sherman\" and .is_latest==true) \n                                    | if (\n                                        .details.outLOAN_BUILDER\n                                        and .details.outLOAN_BUILDER.AmTable\n                                        and .details.outLOAN_BUILDER.AmTable.AmLine\n                                    )\n                                        then .details.outLOAN_BUILDER.AmTable.AmLine[] | select(.Idx==\"1\") | .Pmt\n                                    else null\n                                    end\n                                )\n                            else null\n                            end\n                        ),\n                        GraceDays: 0,\n                        IsACHOriginated: (\n                            if (.bank_details.is_internal_account != null)\n                                then (.bank_details.is_internal_account | not)\n                            else null\n                            end\n                        ),\n                        ACHOriginatedOrganizationNumber: 1,\n                        ExternalAccountName: ( .loan_relations[] | select(.is_primary_borrower==true) | .full_name),\n                        ReceivingRouteNumber: (.bank_details.routing_number // null),\n                        ExternalAccountNumber: (.bank_details.account_number // null),\n                        AccountNumber: (.loan_number // null),\n                        EndDate: null, #\"/Date(1910623380000)/\"\n                        ReceivingPersonNumber: null, #\"920933\"\n                    }\n                ]\n            }\n        ]\n    }    \n}",
        "response_body_spec": "(. as $root| ({\n    apiSuccess: (\n        $root.apiSuccess\n        and (all($root.responses.Output.Responses[]; .WasSuccessful))\n        and (all($root.responses.Output.Responses[].AllotmentResponses[]; .WasSuccessful))\n    )\n} | .apiSuccess as $success | \n    {\n        apiSuccess: $success,\n        errors: ( if ($success | not)\n            then $root.errors | {\n                errorMsg: (.errorMsg? // \"An error occurred while making request.\"),\n                errorNum: (.errorNum? // 500)\n            }\n            else null\n            end\n        ),\n        responses: ( if $success\n            then [$root.responses.Output.Responses[].AllotmentResponses[] | {\n                allotment_number: .AllotmentNumber,\n                payments_account_id: .AccountNumber\n            }]\n            else null\n            end\n        )\n    }\n))",
        "request_body_spec_config": "{\n    \"currentDateTime\": \"1753106520000\"\n}",
        "response_body_spec_config": "{}"
    },
    "ci-fiserv-create_collaterals": {
        "validation_spec": "{}",
        "request_body_spec": "{\n    Input: {\n        ExtensionRequests: null,\n        Requests: ([\n            {\n                __type: \"CollateralMaintenanceRequest:http://www.opensolutions.com/CoreApi\",\n                ParentRequestNumber: null,\n                RequestNumber: null,\n                PropertyList: ( [.loan_relations[] | .collaterals[]] as $collateralList |\n                    if ($collateralList | type == \"array\" and length == 0 )\n                        then {\n                            PropertyTypeCode: \"UNSE\",\n                            PropertyTypeDetailCode: \"UNS\",\n                            PropertyDescription: \"Unsecured\",\n                        }\n                    else $collateralList[] | (\n                        if .category == \"machinery_and_equipment\" \n                            then {\n                                IsPropertyNew: false,\n                                PropertyTypeCode: \"EQUP\",\n                                PropertyTypeDetailCode: \"NON\",\n                                PropertyDescription: (.description // null),\n                            }\n                        elif .category == \"residential_real_estate\" \n                            then {\n                                IsPropertyNew: false,\n                                PropertyTypeCode: (if .type == \"multi_family_dwelling\" then \"MFPR\" elif .type == \"1_4_family_dwelling\" then \"14FR\" else null end),\n                                PropertyTypeDetailCode: \"RE1\",\n                                PropertyDescription: (.collateral_addresses[0] | .address_line_1 + \" \" + .address_line_2 + \" \" + .city),\n                                PropertyId: (.conditions_data[\"REAL-ESTATE\"].current_parcel_id),\n                                ParcelNumber: (.conditions_data[\"REAL-ESTATE\"].current_parcel_id),\n                                OwnerOccupiedCode: (\n                                    if .details.owner_occupied \n                                        then \"OWN\" \n                                    else \"NOWN\" \n                                    end\n                                ),\n                            } \n                        elif .category == \"inventory_accounts_receivable\" and .type == \"all_accounts_receivable\" \n                            then {\n                                IsPropertyNew: false,\n                                PropertyTypeCode: \"AR\",\n                                PropertyTypeDetailCode: \"NON\",\n                                PropertyDescription: (.description // null),\n                            } \n                        elif .category == \"vehicles\" \n                            then {\n                                IsPropertyNew: false,\n                                PropertyTypeCode: (if .type == \"motor_vehicle_new\" then \"AUTN\" elif .type == \"motor_vehicle_used\" then \"AUTU\" elif .type == \"ground_transportation_new\" then \"GRTN\" elif .type == \"ground_transportation_old\" then \"GRTU\" else null end),\n                                PropertyId: (.details.vin // null),\n                                PlateStateCode: (.collateral_addresses[0].state // null),\n                                PropertyYearNumber: (.details.year // null),\n                                PropertyMake: (.details.make // null),\n                                PropertyModel: (.details.model // null),\n                                PropertyValue: (.collateral_value // null),\n                                PropertyDescription: ((.details.year | tostring) + \" \" + .details.make + \" \" + .details.model)\n                            } \n                        elif .category == \"all_business_assets\" and .type == \"all_assets\" \n                            then {\n                                IsPropertyNew: false,\n                                PropertyTypeCode: \"ABSA\",\n                                PropertyTypeDetailCode: \"NON\",\n                                PropertyDescription: (.description // null),\n                            }\n                        elif .category == \"cash_and_equivalents\" and .type == \"deposit_account\" \n                            then {\n                                IsPropertyNew: false,\n                                PropertyTypeCode: \"PSDA\",\n                                PropertyTypeDetailCode: null,\n                                PropertyDescription: (.description // null),\n                            } \n                        elif .category == \"commercial_real_estate\" \n                            then {\n                                IsPropertyNew: false,\n                                PropertyTypeCode: (if .type == \"other_cre\" then \"CREO\" elif .type == \"test\" then \"CLCD\" elif .type == \"office_flex\" then \"CREF\" elif .type == \"commercial_condominium\" then \"COCD\" elif .type == \"church\" then \"CREW\" elif .type == \"warehouse\" then \"CHRC\" elif .type == \"healthcare\" then \"CREH\" elif .type == \"industrial\" then \"CREI\" elif .type == \"shopping_center\" then \"CRES\" elif .type == \"restaurant\" then \"CRER\" elif .type == \"office\" then \"CREB\" elif .type == \"retail\" then \"CRET\" else null end),\n                                PropertyTypeDetailCode: \"RE1\",\n                                PropertyDescription: (.collateral_addresses[0] | .address_line_1 + \" \" + .address_line_2 + \" \" + .city),\n                                PropertyId: (.conditions_data[\"REAL-ESTATE\"].current_parcel_id),\n                                ParcelNumber: (.conditions_data[\"REAL-ESTATE\"].current_parcel_id),\n                                OwnerOccupiedCode: (if .details.owner_occupied then \"OWN\" else \"NOWN\" end),\n                            } \n                        elif .category == \"land\" \n                            then {\n                                IsPropertyNew: false,\n                                PropertyTypeCode: (if .type == \"land_for_development\" then \"CLCD\" else null end),\n                                PropertyTypeDetailCode: \"RE1\",\n                                PropertyDescription: (.collateral_addresses[0] | .address_line_1 + \" \" + .address_line_2 + \" \" + .city),\n                                PropertyId: (.conditions_data[\"REAL-ESTATE\"].current_parcel_id),\n                                ParcelNumber: (.conditions_data[\"REAL-ESTATE\"].current_parcel_id),\n                                OwnerOccupiedCode: (if .details.owner_occupied then \"OWN\" else \"NOWN\" end),\n                            } \n                        else null \n                        end \n                    )\n                    end // []\n                ),\n            }\n        ])\n    },\n    UserAuthentication: {},\n    ShouldCommitOrRollback: false\n}",
        "response_body_spec": "{\n    apiSuccess: (.apiSuccess and all(.responses.Output.Responses[]; .WasSuccessful) // false),\n    errors:( if ((.apiSuccess and all(.responses.Output.Responses[]; .WasSuccessful) // false) | not)\n        then {\n            errorsNum: (.responses.Output.Responses[0].Errors[0].ErrorNumber // 400),\n            errorMsg: (.responses.Output.Responses[0].Errors[0].ErrorMessage // \"Something went wrong\")\n        }\n        else null\n        end\n    ),\n    responses: (if (.responses.Output.Responses[0].CollateralPropertyList) \n        then [ .responses.Output.Responses[].CollateralPropertyList[] | \n        { \n            collateralId: .PropertyNumber \n        }]\n        else null\n        end\n    )\n}\n",
        "request_body_spec_config": "{}",
        "response_body_spec_config": "{}"
    },
    "ci-fiserv-link_collaterals": {
        "validation_spec": "{}",
        "request_body_spec": "(\ndef getCollateralId($collateralList; $responses; $currentCollateral):\n    (\n        $collateralList \n        | index($currentCollateral)\n    ) as $i \n    | $responses[$i].collateralId;\n{\n    Input: {\n        ExtensionRequests: null,\n        Requests: [\n            {\n                __type: \"CollateralMaintenanceRequest:http://www.opensolutions.com/CoreApi\",\n                ParentRequestNumber: null,\n                RequestNumber: null,\n                PropertyList: ( . as $root \n                    | [.loan_relations[] | .collaterals[]] as $collateralList \n                    | [\n                        {\n                            CollateralMargin: (\n                                (\n                                    {\n                                        AcceptDate: \"/Date(\\(now*1000 | floor))/\",\n                                        EffectiveDate: \"/Date(\\(now*1000 | floor))/\",\n                                        AccountNumber: ($root.loan_number // null),\n                                    }\n                                ) + \n                                (\n                                    if ( .category | IN(\"residential_real_estate\", \"commercial_real_estate\", \"land\") )\n                                        then { \n                                            MarginPercent: ( .conditions_data[\"REAL-ESTATE\"].collateral_margin | tonumber? / 100 ) \n                                        }\n                                    else {}\n                                    end\n                                )\n                            ),\n                            PropertyNumber: (\n                                $root.loan_interfaces[]\n                                | select( .interface_type==\"fiserv-collateral-maintenance-response\" and .is_latest==true )\n                                | .details.responses? as $responses\n                                | $collateralList[]\n                                | getCollateralId($collateralList; $responses; .) // null\n                            )\n                        }\n                    ]\n                )\n            }\n        ],\n        UserAuthentication: {}\n    },\n    ShouldCommitOrRollback: false\n}\n)",
        "response_body_spec": "(\n    (\n        .apiSuccess \n        and all(.responses.Output.Responses[]; .WasSuccessful)\n    ) as $isSuccess |\n    .responses | {\n        apiSuccess: $isSuccess,\n        errors: ( if ($isSuccess | not)\n            then \n            {\n                errorNum: (.Output.Responses[0].Errors[0].ErrorNumber // 400),\n                errorMsg: (.Output.Responses[0].Errors[0].ErrorMessage // \"Something went wrong\")\n            }\n            else null\n            end\n        ),\n        responses: ( if ($isSuccess and .Output.Responses[0].CollateralPropertyList)\n            then [ .Output.Responses[0].CollateralPropertyList[] \n            | {\n                collateralId: .PropertyNumber\n            } ]\n            else null\n            end\n        )\n    }\n)",
        "request_body_spec_config": "{}",
        "response_body_spec_config": "{}"
    }
}

org_config = (
    OrganizationConfiguration.objects.all()
    .order_by("-version_major", "-version_minor", "-version_patch")
    .first()
)
for key, value in interfaces.items():
    configuration, _ = Configuration.objects.update_or_create(
        name=key, interface_type=key, defaults={"details": value}
    )
    org_config.details["GLOBAL"][key] = {
        "name": configuration.name,
        "version": configuration.version,
    }
    org_config.save(update_fields=["details"])


from los.integrations.models import CredentialsManager
credentials={
    "ci-fiserv": {
        "ApplID": "",
        "UserId": "",
        "api_url": "https://host.docker.internal:9178",
        "timeout": 20,
        "DeviceId": "",
        "Password": "$",
        "auth_url": "/secoreapi/SAF/ProductIntegration/ProductIntegration.asmx",
        "ProdDefCd": "",
        "ProdEnvCd": "",
        "auth_token_ttl": None,
        "NetworkNodeName": "",
        "AuthorizationType": "",
        "default_namespaces": {
            "soap": "http://schemas.xmlsoap.org/soap/envelope/",
            "opensol": "http://www.opensolutions.com/"
        }
    }
}
for key, value in credentials.items():
    cred, created = CredentialsManager.objects.get_or_create(
        interface_type=key,
        defaults={'details': value}
    )
    if not created:
        cred.details = value
        cred.save()